<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Time Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div id="welcome-screen" class="pixel-box" style="display: none;">
            <h1 class="pixel-title">Pixel Time Tracker</h1>
            <div class="pixel-welcome">
                <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –ø–∏–∫—Å–µ–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏!</p>
                <p>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.</p>
            </div>
        </div>

        <div id="main-screen" class="pixel-box">
            <div class="pixel-header">
                <h2>–ü—Ä–∏–≤–µ—Ç, <span id="userDisplayName">{{ user.username if user else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</span>!</h2>
                <div class="pixel-achievements">
                    <div class="pixel-achievement" id="achievement1">üéØ</div>
                    <div class="pixel-achievement" id="achievement2">‚è∞</div>
                    <div class="pixel-achievement" id="achievement3">üèÜ</div>
                </div>
            </div>

            <div class="pixel-timer-container">
                <div class="pixel-timer" id="timer">00:00:00</div>
                <div class="pixel-timer-controls">
                    <button class="pixel-button" id="startTrackingBtn">–°—Ç–∞—Ä—Ç</button>
                    <button class="pixel-button" id="stopTrackingBtn" disabled>–°—Ç–æ–ø</button>
                </div>
            </div>

            <div class="pixel-input-group">
                <input type="text" class="pixel-input" id="activity" placeholder="–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ?">
                <select class="pixel-input" id="category">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    <option value="work">–†–∞–±–æ—Ç–∞</option>
                    <option value="study">–£—á–µ–±–∞</option>
                    <option value="hobby">–•–æ–±–±–∏</option>
                    <option value="sport">–°–ø–æ—Ä—Ç</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
                <input type="text" class="pixel-input" id="tags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
            </div>

            <div class="pixel-stats-container">
                <div class="pixel-stats-grid">
                    <div class="pixel-stat-box">
                        <h3>–°–µ–≥–æ–¥–Ω—è</h3>
                        <p id="todayTime">0 –º–∏–Ω</p>
                    </div>
                    <div class="pixel-stat-box">
                        <h3>–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤</h3>
                        <p id="totalTracks">0</p>
                    </div>
                    <div class="pixel-stat-box">
                        <h3>–û–±—â–µ–µ –≤—Ä–µ–º—è</h3>
                        <p id="totalTime">0 —á</p>
                    </div>
                </div>
            </div>

            <div class="pixel-categories">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <div id="categoryStats" class="pixel-category-grid"></div>
            </div>
        </div>
    </div>

    <script>
        let startTime;
        let timerInterval;
        let isTracking = false;
        let tg = window.Telegram.WebApp;

        const welcomeScreen = document.getElementById('welcome-screen');
        const mainScreen = document.getElementById('main-screen');
        const startTrackingBtn = document.getElementById('startTrackingBtn');
        const stopTrackingBtn = document.getElementById('stopTrackingBtn');
        const activityInput = document.getElementById('activity');
        const categorySelect = document.getElementById('category');
        const tagsInput = document.getElementById('tags');
        const timer = document.getElementById('timer');
        const userDisplayName = document.getElementById('userDisplayName');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        document.addEventListener('DOMContentLoaded', function() {
            if (tg.initDataUnsafe.user) {
                mainScreen.style.display = 'block';
                welcomeScreen.style.display = 'none';
                userDisplayName.textContent = tg.initDataUnsafe.user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                updateStats();
            } else {
                mainScreen.style.display = 'none';
                welcomeScreen.style.display = 'block';
            }
        });

        function updateTimer() {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            timer.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function startTracking() {
            const activity = activityInput.value;
            const category = categorySelect.value;
            const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);

            if (!activity) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
                return;
            }

            startTime = new Date();
            isTracking = true;
            startTrackingBtn.disabled = true;
            stopTrackingBtn.disabled = false;
            activityInput.disabled = true;
            categorySelect.disabled = true;
            tagsInput.disabled = true;

            timerInterval = setInterval(updateTimer, 1000);

            try {
                const response = await fetch('/api/track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activity,
                        category,
                        tags
                    }),
                });
                const data = await response.json();
                console.log(data);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function stopTracking() {
            clearInterval(timerInterval);
            isTracking = false;
            startTrackingBtn.disabled = false;
            stopTrackingBtn.disabled = true;
            activityInput.disabled = false;
            categorySelect.disabled = false;
            tagsInput.disabled = false;

            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                console.log(data);
                updateStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalTracks').textContent = data.total_tracks;
                document.getElementById('totalTime').textContent = `${Math.floor(data.total_duration / 3600)} —á`;
                document.getElementById('todayTime').textContent = `${Math.floor(data.daily_stats.total_duration / 60)} –º–∏–Ω`;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const categoryStats = document.getElementById('categoryStats');
                categoryStats.innerHTML = '';
                Object.entries(data.categories).forEach(([category, duration]) => {
                    const categoryBox = document.createElement('div');
                    categoryBox.className = 'pixel-category-box';
                    categoryBox.innerHTML = `
                        <h4>${category}</h4>
                        <p>${Math.floor(duration / 60)} –º–∏–Ω</p>
                    `;
                    categoryStats.appendChild(categoryBox);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        startTrackingBtn.addEventListener('click', startTracking);
        stopTrackingBtn.addEventListener('click', stopTracking);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∏–∫—Å–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.pixel-button').forEach(button => {
            button.addEventListener('mouseover', () => {
                button.style.transform = 'scale(1.05)';
            });
            button.addEventListener('mouseout', () => {
                button.style.transform = 'scale(1)';
            });
        });
    </script>
</body>
</html> 